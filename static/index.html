<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Autoscale Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="min-h-screen bg-slate-950 text-slate-100">
    <div class="mx-auto max-w-3xl px-4 py-10">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 shadow">
        <div class="flex items-center justify-between gap-4">
          <div>
            <h1 class="text-2xl font-semibold">Autoscale Demo</h1>
            <p class="mt-1 text-sm text-slate-300">
              UI sederhana untuk mengetes endpoint FastAPI di Railway.
            </p>
          </div>
          <span id="badge" class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200">
            idle
          </span>
        </div>

        <div class="mt-6 grid gap-4 md:grid-cols-2">
          <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-4">
            <h2 class="text-sm font-medium text-slate-200">Service info</h2>
            <pre id="info" class="mt-3 overflow-auto rounded-lg bg-slate-950 p-3 text-xs text-slate-200">loading...</pre>
            <button id="refreshInfo"
              class="mt-3 w-full rounded-xl bg-slate-200 px-4 py-2 text-sm font-medium text-slate-900 hover:bg-white">
              Refresh Info
            </button>
          </div>

          <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-4">
            <h2 class="text-sm font-medium text-slate-200">Load test (manual)</h2>

            <label class="mt-3 block text-xs text-slate-300">Durasi kerja per request (ms)</label>
            <input id="ms" type="number" value="300" min="0" max="5000"
              class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-400" />

            <label class="mt-3 block text-xs text-slate-300">Jumlah request (batch)</label>
            <input id="count" type="number" value="20" min="1" max="500"
              class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-400" />

            <button id="run"
              class="mt-4 w-full rounded-xl bg-indigo-500 px-4 py-2 text-sm font-medium hover:bg-indigo-400">
              Jalankan Batch Request
            </button>

            <div class="mt-4 grid grid-cols-2 gap-3">
              <div class="rounded-xl border border-slate-800 bg-slate-950 p-3">
                <div class="text-xs text-slate-300">Sukses</div>
                <div id="ok" class="mt-1 text-xl font-semibold">0</div>
              </div>
              <div class="rounded-xl border border-slate-800 bg-slate-950 p-3">
                <div class="text-xs text-slate-300">Gagal</div>
                <div id="fail" class="mt-1 text-xl font-semibold">0</div>
              </div>
            </div>

            <pre id="log" class="mt-4 h-44 overflow-auto rounded-xl border border-slate-800 bg-slate-950 p-3 text-xs text-slate-200">Klik "Jalankan Batch Request" untuk mulai.</pre>
          </div>
        </div>

        <p class="mt-6 text-xs text-slate-400">
          S1IF-11-02 <code class="rounded bg-slate-800 px-1">The Rantau</code>.
        </p>
      </div>
    </div>

    <script>
      const badge = document.getElementById("badge");
      const info = document.getElementById("info");
      const log = document.getElementById("log");
      const okEl = document.getElementById("ok");
      const failEl = document.getElementById("fail");

      function setBadge(state) {
        badge.textContent = state;
        badge.className =
          state === "running"
            ? "rounded-full bg-indigo-500 px-3 py-1 text-xs text-white"
            : state === "error"
            ? "rounded-full bg-rose-500 px-3 py-1 text-xs text-white"
            : "rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200";
      }

      async function refreshInfo() {
        setBadge("running");
        try {
          const r = await fetch("/api/info");
          const j = await r.json();
          info.textContent = JSON.stringify(j, null, 2);
          setBadge("idle");
        } catch (e) {
          info.textContent = String(e);
          setBadge("error");
        }
      }

      document.getElementById("refreshInfo").addEventListener("click", refreshInfo);

      document.getElementById("run").addEventListener("click", async () => {
        const ms = Number(document.getElementById("ms").value || 300);
        const count = Number(document.getElementById("count").value || 20);

        okEl.textContent = "0";
        failEl.textContent = "0";
        log.textContent = `Running ${count} requests to /work?ms=${ms} ...\n`;
        setBadge("running");

        let ok = 0, fail = 0;
        const started = performance.now();

        // batch paralel sederhana (bukan pengganti hey, tapi enak buat demo)
        const tasks = Array.from({ length: count }, async (_, i) => {
          try {
            const r = await fetch(`/work?ms=${ms}`);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const j = await r.json();
            ok++;
            log.textContent += `#${i + 1} OK host=${j.hostname} worked=${j.worked_ms}ms\n`;
          } catch (e) {
            fail++;
            log.textContent += `#${i + 1} FAIL ${e}\n`;
          }
          okEl.textContent = String(ok);
          failEl.textContent = String(fail);
        });

        await Promise.all(tasks);
        const dur = Math.round(performance.now() - started);

        log.textContent += `\nDone in ${dur}ms. OK=${ok} FAIL=${fail}\n`;
        setBadge(fail > 0 ? "error" : "idle");
      });

      refreshInfo();
    </script>
  </body>
</html>
